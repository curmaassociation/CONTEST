<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Your Photo ‚Äì CURUMA Photography Contest</title>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    /* (Same CSS styles as you posted ‚Äî unchanged for brevity) */
  </style>
</head>
<body>
  <header>
    <img src="/Images/curuma_logo.png" alt="CURUMA Logo" />
    <h1>Photo & Payment Upload</h1>
    <p>Step 2 of 2: Finalize your submission</p>
  </header>

  <main>
    <div class="instagram-guide">
      <h3>üì∏ Instagram Post Preview</h3>
      <p>This is exactly how your photo will appear on @curaj_photocontest2025</p>
    </div>

    <form id="uploadForm">
      <!-- Hidden Prefill Fields -->
      <input type="hidden" id="hiddenName" name="name">
      <input type="hidden" id="hiddenEnrollment" name="enrollment">
      <input type="hidden" id="hiddenDepartment" name="department">
      <input type="hidden" id="hiddenPhone" name="phone">
      <input type="hidden" id="hiddenState" name="state">
      <input type="hidden" id="hiddenCategory" name="category">
      <input type="hidden" id="hiddenInstagram" name="instagram">
      <input type="hidden" id="hiddenCuraj" name="curaj">
      <input type="hidden" id="hiddenWhy" name="why">
      <input type="hidden" id="hiddenPaymentCode" name="paymentCode">

      <div class="form-group">
        <label for="photo">Upload Your Contest Photo (Max 5MB)</label>
        <input type="file" id="photo" name="photo" accept="image/*" required />
        <p class="file-hint">Formats: JPG/PNG (Square 1:1 ratio recommended)</p>
        <p class="ratio-warning" id="ratioWarning"></p>
        <div class="preview-container">
          <div class="instagram-preview">
            <img id="instagramPreview" src="/Images/upload_placeholder.png" alt="Preview will appear here">
            <div class="preview-caption" id="previewCaption"></div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="caption">Photo Caption/Title</label>
        <input type="text" id="caption" name="caption" placeholder="Give your photo a title..." required />
        <p class="file-hint">This will appear below your photo on Instagram</p>
      </div>

      <div class="form-group">
        <label for="screenshot">Payment Receipt Screenshot (Max 5MB)</label>
        <input type="file" id="screenshot" name="screenshot" accept="image/*" required />
        <p class="file-hint">Must show UPI Transaction ID and ‚Çπ30 payment</p>
      </div>

      <div class="form-group checkbox">
        <label>
          <input type="checkbox" name="consent" required />
          I confirm this is my original work and I accept all contest rules
        </label>
      </div>

      <div class="form-actions">
        <a href="/registration.html" class="button secondary">‚Üê Back to Registration</a>
        <button type="button" class="button" id="submitButton">Submit Entry</button>
      </div>
    </form>
  </main>

  <!-- Confirmation Modal -->
  <div id="confirmationModal">
    <div class="modal-content">
      <h2>Ready to Submit?</h2>
      <p>Your entry will be sent to CURUMA organizers via WhatsApp.</p>
      <div id="submissionSummary"></div>

      <div class="whatsapp-note">
        <h3>üì± WhatsApp Submission Instructions</h3>
        <ol>
          <li><strong>Send</strong> the pre-filled message that appears</li>
          <li><strong>Attach</strong> your photo in the next message</li>
          <li><strong>Complete</strong> by sending both messages</li>
        </ol>
        <p style="font-size: 13px;">Note: You must manually attach your photo after sending the details</p>
      </div>

      <div class="form-actions">
        <button id="cancelButton" class="button secondary">Cancel</button>
        <button id="confirmSendButton" class="button">Send via WhatsApp</button>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2025 CURUMA ‚Äì Central University of Rajasthan Malayali Association
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const urlParams = new URLSearchParams(window.location.search);
      const fields = [
        'name', 'enrollment', 'department', 'phone', 'state',
        'category', 'instagram', 'curaj', 'why', 'paymentCode'
      ];
      fields.forEach(field => {
        const el = document.getElementById(`hidden${field.charAt(0).toUpperCase() + field.slice(1)}`);
        if (el) el.value = urlParams.get(field) || '';
      });

      const photoInput = document.getElementById('photo');
      const instagramPreview = document.getElementById('instagramPreview');
      const previewCaption = document.getElementById('previewCaption');
      const ratioWarning = document.getElementById('ratioWarning');

      photoInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
          alert('File size exceeds 5MB limit');
          this.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = function (event) {
          instagramPreview.src = event.target.result;

          const img = new Image();
          img.onload = function () {
            const ratio = img.width / img.height;
            if (ratio < 0.9 || ratio > 1.1) {
              ratioWarning.textContent = `‚ö†Ô∏è Image ratio is ${img.width}x${img.height} (${ratio.toFixed(2)}:1). Use a square photo for best results.`;
              ratioWarning.style.display = 'block';
            } else {
              ratioWarning.style.display = 'none';
            }
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });

      document.getElementById('caption').addEventListener('input', function () {
        previewCaption.textContent = this.value;
      });

      document.getElementById('submitButton').addEventListener('click', function () {
        const form = document.getElementById('uploadForm');
        if (!form.checkValidity()) {
          alert('Please complete all required fields');
          return;
        }
        if (!photoInput.files[0]) {
          alert('Please upload your contest photo');
          return;
        }
        showConfirmationModal();
      });

      document.getElementById('cancelButton').addEventListener('click', function () {
        document.getElementById('confirmationModal').style.display = 'none';
      });

      document.getElementById('confirmSendButton').addEventListener('click', sendToWhatsApp);

      function showConfirmationModal() {
        const summary = `
          <p><strong>Name:</strong> ${document.getElementById('hiddenName').value}</p>
          <p><strong>Enrollment:</strong> ${document.getElementById('hiddenEnrollment').value}</p>
          <p><strong>Department:</strong> ${document.getElementById('hiddenDepartment').value}</p>
          <p><strong>Instagram:</strong> @${document.getElementById('hiddenInstagram').value}</p>
          <p><strong>Caption:</strong> "${document.getElementById('caption').value}"</p>
          <p><strong>Payment Code:</strong> ${document.getElementById('hiddenPaymentCode').value}</p>
        `;
        document.getElementById('submissionSummary').innerHTML = summary;
        document.getElementById('confirmationModal').style.display = 'flex';
      }

      function sendToWhatsApp() {
        const message =
          `üì∏ *CURUMA Photo Contest Submission* üì∏\n\n` +
          `üë§ *Name:* ${document.getElementById('hiddenName').value}\n` +
          `üéì *Enrollment:* ${document.getElementById('hiddenEnrollment').value}\n` +
          `üèõÔ∏è *Department:* ${document.getElementById('hiddenDepartment').value}\n` +
          `üì± *Instagram:* @${document.getElementById('hiddenInstagram').value.replace('@', '')}\n\n` +
          `‚úèÔ∏è *Caption:* "${document.getElementById('caption').value}"\n` +
          `üí∞ *Payment Code:* ${document.getElementById('hiddenPaymentCode').value}\n\n` +
          `_Please find the photo attached in the next message_`;

        const encoded = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/918547432287?text=${encoded}`;

        const formData = new FormData(document.getElementById('uploadForm'));
        fetch('/submit', {
          method: 'POST',
          body: formData
        })
          .then(res => {
            if (!res.ok) throw new Error('Submission failed');
            window.open(whatsappUrl, '_blank');
            document.getElementById('confirmationModal').style.display = 'none';
          })
          .catch(err => {
            console.error(err);
            window.open(whatsappUrl, '_blank');
            document.getElementById('confirmationModal').style.display = 'none';
          });
      }
    });
  </script>
</body>
</html>
